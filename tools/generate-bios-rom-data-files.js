#!/usr/bin/env node

const fs = require('fs/promises');
const path = require('path');

async function generateBiosRomDataFiles(romFilePath, outputFilePath) {
  const romContent = await fs.readFile(romFilePath);

  const hContent = [
    '// BIOS ROM data automatically generated by generate-bios-rom-data-files.js',
    `// Source: ${path.basename(romFilePath)}`,
    '',
    '#ifndef YAX86_BIOS_ROM_DATA_H',
    '#define YAX86_BIOS_ROM_DATA_H',
    '',
    '#include <stdint.h>',
    '',
    'enum {',
    '  kBIOSROMDataSize = ' + romContent.length + ',',
    '};',
    '',
    '#ifndef YAX86_BIOS_BUNDLE',
    'extern const uint8_t kBIOSROMData[kBIOSROMDataSize];',
    '#endif // YAX86_BIOS_BUNDLE',
    '',
    '#endif // YAX86_BIOS_ROM_DATA_H',
    '',
  ].join('\n');
  await fs.writeFile(`${outputFilePath}.h`, hContent, 'utf8');

  const cContent = [
    `// BIOS ROM data automatically generated by generate-bios-rom-data-files.js`,
    `// Source: ${path.basename(romFilePath)}`,
    '',
    '#include <stdint.h>',
    '',
    'const uint8_t kBIOSROMData[] = {',
    Array.from(romContent)
      .map(
        (byte, index) =>
          (index % 16 === 0 && index > 0 ? `\n` : '') +
          `0x${byte.toString(16).padStart(2, '0')},`
      )
      .join(''),
    '};',
    '',
  ].join('\n');
  await fs.writeFile(`${outputFilePath}.c`, cContent, 'utf8');
}

if (require.main === module) {
  const args = process.argv.slice(2);
  if (args.length < 2) {
    console.error('Usage: generate-bios-rom-data-file.js XXX.rom output_file');
    process.exit(1);
  }
  const romFilePath = args[0];
  const outputFilePath = args[1];

  (async () => {
    await generateBiosRomDataFiles(romFilePath, outputFilePath);
  })();
}
